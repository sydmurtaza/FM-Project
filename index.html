<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Analysis Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.9/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.25.0/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/z3-solver@4.12.2/build/z3.js"></script>
    <style>
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        #cfg-original, #cfg-ssa {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            background: #fff;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ... [Previous class implementations remain unchanged]

        function App() {
            const [mode, setMode] = useState('Verification');
            const [program1, setProgram1] = useState('x := 3;\nif (x < 5) {\n    y := x + 1;\n} else {\n    y := x - 1;\n}\nassert(y > 0);');
            const [program2, setProgram2] = useState('');
            const [unrollDepth, setUnrollDepth] = useState(3);
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (result && !error) {
                    try {
                        const cfgGen = new CFGGenerator();
                        const ast1 = new Parser(program1).parseProgram();
                        const cfg1 = cfgGen.generateCFG(ast1);
                        
                        const cy1 = cytoscape({
                            container: document.getElementById('cfg-original'),
                            elements: [...cfg1.nodes, ...cfg1.edges],
                            style: [
                                {
                                    selector: 'node',
                                    style: {
                                        'label': 'data(label)',
                                        'text-wrap': 'wrap',
                                        'text-max-width': '100px',
                                        'background-color': '#fff',
                                        'border-width': 1,
                                        'border-color': '#000',
                                        'padding': '10px'
                                    }
                                },
                                {
                                    selector: 'edge',
                                    style: {
                                        'label': 'data(label)',
                                        'curve-style': 'bezier',
                                        'target-arrow-shape': 'triangle',
                                        'arrow-scale': 1.5,
                                        'line-color': '#666',
                                        'target-arrow-color': '#666'
                                    }
                                }
                            ],
                            layout: {
                                name: 'dagre',
                                rankDir: 'TB',
                                nodeSep: 50,
                                rankSep: 100
                            }
                        });

                        const ssaConverter = new SSAConverter();
                        const ssa1 = ssaConverter.convertProgram(ast1, unrollDepth);
                        const optimizedSsa1 = new SSAOptimizer().optimize({ ...ssa1 });
                        const ssaCfg1 = cfgGen.generateSSACFG(optimizedSsa1);
                        
                        const cy2 = cytoscape({
                            container: document.getElementById('cfg-ssa'),
                            elements: [...ssaCfg1.nodes, ...ssaCfg1.edges],
                            style: [
                                {
                                    selector: 'node',
                                    style: {
                                        'label': 'data(label)',
                                        'text-wrap': 'wrap',
                                        'text-max-width': '100px',
                                        'background-color': '#fff',
                                        'border-width': 1,
                                        'border-color': '#000',
                                        'padding': '10px'
                                    }
                                },
                                {
                                    selector: 'edge',
                                    style: {
                                        'label': 'data(label)',
                                        'curve-style': 'bezier',
                                        'target-arrow-shape': 'triangle',
                                        'arrow-scale': 1.5,
                                        'line-color': '#666',
                                        'target-arrow-color': '#666'
                                    }
                                }
                            ],
                            layout: {
                                name: 'dagre',
                                rankDir: 'TB',
                                nodeSep: 50,
                                rankSep: 100
                            }
                        });

                        // Fit the graphs to the container
                        cy1.fit();
                        cy2.fit();
                    } catch (e) {
                        console.error('Error rendering CFGs:', e);
                        setError('Failed to render control flow graphs: ' + e.message);
                    }
                }
            }, [result]);

            const handleSubmit = async () => {
                setLoading(true);
                setError(null);
                setResult(null);

                try {
                    const parser = new Parser(program1);
                    const ast1 = parser.parseProgram();
                    const ssaConverter = new SSAConverter();
                    const ssa1 = ssaConverter.convertProgram(ast1, unrollDepth);
                    const optimizer = new SSAOptimizer();
                    const optimizedSsa1 = optimizer.optimize({ ...ssa1 });
                    const smtGen = new SMTGenerator();

                    if (mode === 'Verification') {
                        const z3 = await Z3.init();
                        const verificationResult = await smtGen.verifyProgram(optimizedSsa1, z3);
                        setResult({
                            original: program1,
                            ssa: ssa1,
                            optimizedSsa: optimizedSsa1,
                            ...verificationResult
                        });
                    } else {
                        const parser2 = new Parser(program2);
                        const ast2 = parser2.parseProgram();
                        const ssa2 = ssaConverter.convertProgram(ast2, unrollDepth);
                        const optimizedSsa2 = optimizer.optimize({ ...ssa2 });
                        const z3 = await Z3.init();
                        const equivalenceResult = await smtGen.checkEquivalence(optimizedSsa1, optimizedSsa2, z3);
                        setResult({
                            original: [program1, program2],
                            ssa: [ssa1, ssa2],
                            optimizedSsa: [optimizedSsa1, optimizedSsa2],
                            ...equivalenceResult
                        });
                    }
                } catch (e) {
                    console.error('Analysis Error:', e);
                    setError(`Analysis failed: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const renderSSA = (ssa) => {
                return ssa.statements.map((stmt, i) => (
                    <div key={i} className="mb-1">{new CFGGenerator().stmtToString(stmt)}</div>
                )).concat(ssa.phiNodes.map((phi, i) => (
                    <div key={`phi${i}`} className="mb-1">{`${phi.target} = phi(${phi.vars.join(', ')})`}</div>
                )));
            };

            return (
                <div className="container mx-auto p-6 max-w-6xl">
                    <h1 className="text-3xl font-bold mb-6 text-gray-800">Program Analysis Tool</h1>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div className="bg-white p-6 rounded-lg shadow-sm">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Mode:</label>
                            <select
                                value={mode}
                                onChange={(e) => setMode(e.target.value)}
                                className="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"
                            >
                                <option value="Verification">Verification</option>
                                <option value="Equivalence">Equivalence</option>
                            </select>
                        </div>

                        <div className="bg-white p-6 rounded-lg shadow-sm">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Unrolling Depth:</label>
                            <input
                                type="number"
                                value={unrollDepth}
                                onChange={(e) => setUnrollDepth(parseInt(e.target.value))}
                                className="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"
                                min="1"
                            />
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-sm mb-6">
                        <label className="block text-sm font-medium text-gray-700 mb-2">Program 1:</label>
                        <textarea
                            value={program1}
                            onChange={(e) => setProgram1(e.target.value)}
                            className="w-full border border-gray-300 rounded-md shadow-sm p-2 h-48 font-mono focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Enter your program here..."
                        />
                    </div>

                    {mode === 'Equivalence' && (
                        <div className="bg-white p-6 rounded-lg shadow-sm mb-6">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Program 2:</label>
                            <textarea
                                value={program2}
                                onChange={(e) => setProgram2(e.target.value)}
                                className="w-full border border-gray-300 rounded-md shadow-sm p-2 h-48 font-mono focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Enter the second program here..."
                            />
                        </div>
                    )}

                    <button
                        onClick={handleSubmit}
                        disabled={loading}
                        className={`w-full bg-indigo-600 text-white p-3 rounded-md font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 ${loading ? 'opacity-75 cursor-not-allowed' : ''}`}
                    >
                        {loading ? 'Analyzing...' : 'Analyze'}
                    </button>

                    {loading && (
                        <div className="loading mt-6">
                            <div className="loading-spinner"></div>
                        </div>
                    )}

                    {error && (
                        <div className="mt-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md">
                            {error}
                        </div>
                    )}

                    {result && !error && (
                        <div className="mt-6 space-y-6">
                            <div className="bg-white p-6 rounded-lg shadow-sm">
                                <h2 className="text-xl font-semibold mb-4 text-gray-800">Analysis Results</h2>
                                
                                <div className="mb-6">
                                    <h3 className="text-lg font-medium mb-2 text-gray-700">Original Program{mode === 'Equivalence' ? 's' : ''}</h3>
                                    <pre className="code-block">
                                        {mode === 'Equivalence' ? result.original.join('\n\n=== Program 2 ===\n\n') : result.original}
                                    </pre>
                                </div>

                                <div className="mb-6">
                                    <h3 className="text-lg font-medium mb-2 text-gray-700">SSA Form</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <h4 className="font-medium mb-2 text-gray-600">Unoptimized</h4>
                                            <pre className="code-block">
                                                {mode === 'Equivalence' ? (
                                                    <>
                                                        <div className="font-medium">Program 1:</div>
                                                        {renderSSA(result.ssa[0])}
                                                        <div className="font-medium mt-4">Program 2:</div>
                                                        {renderSSA(result.ssa[1])}
                                                    </>
                                                ) : renderSSA(result.ssa)}
                                            </pre>
                                        </div>
                                        <div>
                                            <h4 className="font-medium mb-2 text-gray-600">Optimized</h4>
                                            <pre className="code-block">
                                                {mode === 'Equivalence' ? (
                                                    <>
                                                        <div className="font-medium">Program 1:</div>
                                                        {renderSSA(result.optimizedSsa[0])}
                                                        <div className="font-medium mt-4">Program 2:</div>
                                                        {renderSSA(result.optimizedSsa[1])}
                                                    </>
                                                ) : renderSSA(result.optimizedSsa)}
                                            </pre>
                                        </div>
                                    </div>
                                </div>

                                <div className="mb-6">
                                    <h3 className="text-lg font-medium mb-2 text-gray-700">SMT Constraints</h3>
                                    <pre className="code-block overflow-x-auto">{result.smt}</pre>
                                </div>

                                <div className="mb-6">
                                    <h3 className="text-lg font-medium mb-2 text-gray-700">Control Flow Graphs</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <h4 className="font-medium mb-2 text-gray-600">Original CFG</h4>
                                            <div id="cfg-original"></div>
                                        </div>
                                        <div>
                                            <h4 className="font-medium mb-2 text-gray-600">SSA CFG</h4>
                                            <div id="cfg-ssa"></div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-lg font-medium mb-2 text-gray-700">
                                        Result: <span className={result.result === 'Satisfiable' || result.result === 'Equivalent' ? 'text-green-600' : 'text-red-600'}>
                                            {result.result}
                                        </span>
                                    </h3>
                                    
                                    {result.examples.length > 0 && (
                                        <div className="mb-4">
                                            <h4 className="font-medium mb-2 text-gray-600">Example(s):</h4>
                                            {result.examples.map((ex, i) => (
                                                <pre key={i} className="code-block">
                                                    {JSON.stringify(ex, null, 2)}
                                                </pre>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {result.counterexamples.length > 0 && (
                                        <div>
                                            <h4 className="font-medium mb-2 text-gray-600">Counterexample(s):</h4>
                                            {result.counterexamples.map((cex, i) => (
                                                <pre key={i} className="code-block">
                                                    {JSON.stringify(cex, null, 2)}
                                                </pre>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>